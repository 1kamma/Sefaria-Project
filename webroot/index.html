<!DOCTYPE html>
<html>

<head>
	
	<title>Sefaria</title>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="/js/jquery-ui/css/black-tie/jquery-ui-1.8.7.custom.css">
	
	<style>
		body {
			height: 100%;
			overflow-x: hidden;
			font-family: serif;
			background: white;
		}
		
		.gradient {
			background: -moz-linear-gradient(top,  #fefefe,  #e9e9e9);
			background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#fefefe), to(#e9e9e9));
		}
		
		#top {
			position: fixed;
			top: 0%;
			left: 0%;
			width: 100%;
			z-index: 5;
			padding: 10px;

			-webkit-box-shadow: 2px 2px 6px #333333;
			-moz-box-shadow: 2px 2px 6px #333333;
		}
		
		#header {
			font-size: 27px;
			font-weight: bold;
			margin: 0px 0px 0px 15px;
			float: left;
		}
		
		#about {
			margin-left: 12px;
			font-size: 14px;
			font-weight: normal;
			cursor: pointer;
			height: 16px;
			width: 104px;
			display: inline-block; 
			position: relative;
		}
		
		#about .ui-icon {
			display: inline-block;
			position: relative;
			top: 4px;
			left: -2px;	
		}
		
		#aboutMenu {
			display: none;
			margin-top: 6px;
			margin-left: -15px;
			padding: 15px 17px;
			width: 340px;
			border-radius: 4px;
			-webkit-box-shadow: 1px 1px 3px #333333;
			-moz-box-shadow: 1px 1px 3px #333333;

			
		}
		
		#aboutTitle {
			font-size: 17px;
			margin-bottom: 2px;
		}
		
		#aboutSource {
			color: #777;
			margin-bottom: 6px;
		}
		
		#about .action {
			display: inline;
			position: relative;
			top: 7px; 
			margin-right: 14px;
			font-style: italic;
		}
		
		#about .action:hover {
			text-decoration: underline;
		}
		
		#gotoBox {
			position: absolute;
			z-index: 10;
			padding: 5px 25px;
			right: 39px;
			top: 50px;
			display: none;
			font-size: 17px;
			-webkit-box-shadow: 2px 2px 12px #333333;
			-moz-box-shadow: 2px 2px 12px #333333;
			border-radius: 5px;
			vertical-align: middle;
			
		}
		
		.dialogTitle {
			font-size: 18px;
			margin: 10px 0px;
		}
		
		#openEg {
			font-style: italic;
			font-size: 14px;
			margin: 5px 8px 8px 8px;
		}
		
		#goto {
			font-size: 17px;
			width: 265px;
			
		}
		
		#closeGoto {
			float: right;
			font-size: 17px;
			position: relative;
			left: 18px;
			font-family: sans-serif;
			cursor: pointer;
		}
		
		
		#topLine {
			height: 1px;
			background: black;
		}
		
		#topButtons {
			float: right;
			margin: 5px 20px;
		}
		
		#editButtons {
			display: none;
		}
		
				
		.button {
			font-weight: bold;
			font-size: 16px;
			height: 20px;
			padding: 0px 12px;
			margin: 0px 6px;
			display: block;
			float: right;
			letter-spacing: 1px;
			text-align: center;
			vertical-align: center;
			border-radius: 8px;
			border: 1px solid #aaa;
			-webkit-box-shadow: 2px 2px 3px #333333;
			-moz-box-shadow: 2px 2px 3px #333333;
		}
	
		
		.button:hover {
			background: #ccc;
			cursor: pointer;
		}
		
		#loadingImg {
			margin-left: 16px;
			height: 20px;
			position: relative;
			top: 2px;
		}
		
		.toggle {
			font-size: 14px;
			margin: 0px 6px;
			text-align: center;
			vertical-align: center;
			border-radius: 8px;
			border: 1px solid #aaa;
			-webkit-box-shadow: 2px 2px 3px #333333;
			-moz-box-shadow: 2px 2px 3px #333333;			
		}
		
		.toggleOption {
			cursor: pointer;
			padding: 0px 8px;
			letter-spacing: 1px;
		}
		
		.toggleOption + .toggleOption {
			border-left: 1px solid #777;
		
		}
		
		.toggleOption:first-child {
			border-top-left-radius: 8px;
			border-bottom-left-radius: 8px;


		}
		
		.toggleOption:last-child {
			border-top-right-radius: 8px;
			border-bottom-right-radius: 8px;


		}
		
		.toggleOption.active {
			background: #d8d8d8;

		}

		.toggleOption:hover {
			background: #ccc;
		}
		
		
		#topButtons .toggle {
			position: relative;
			top: 2px;
		}
		
		#languageToggle, #layoutToggle, #biLayoutToggle {
			display: none;
		}
		
		#basetext {
			position: absolute;
			width: 56%;
			top: 126px;
			left: 8%;
			font-size: 24px;
			text-align: justify;
			letter-spacing: .7px;
			line-height: 1.3;
			z-index: 2;
			background: inherit;
			font-family: serif;
			padding-bottom: 40px;
		}
		
		#basetext.noCommentary {
			width: 650px;
			left: 50%;
			margin-left: -325px;
		}
		
		#basetext.versionCompare,
		#basetext.versionCompare.hebrew {
			width: 42%;
			left: 5%;
			top: 196px;
			margin-left: 0px;
		}
		
		#basetext.versionCompare .verseNum {
			right: -38px;
			left: auto;
		}
		
		#newVersion, #newVersionMirror {
			display: none;
			position: absolute;
			top: 176px;
			width: 40%;
			right: 5%; 
			font-size: 24px;
			padding: 18px;
			letter-spacing: .7px;
			line-height: 1.3;
			font-family: serif;

		}
		
		#newVersionMirror {
			border: 1px solid black;
		}
		
		#basetext > .verse:first-child > .verseNum {
			display: none;
		}
		
		#basetext.versionCompare > .verse:first-child > .verseNum,
		#basetext > .verse.block:first-child > .verseNum,
		#basetext.bilingual .verse:first-child > .verseNum,
		#basetext.hebrew .verse:first-child > .verseNum {
			display: block;
		}
		
		#basetext.versionCompare .verse .lfc {
			font-size: inherit;
			margin: 0;
			font-variant: normal;
		}
		
		.verse {
			cursor: pointer;
			margin-right: 7px;
			border-radius: 6px;
			-moz-border-radius: 6px;
		}
	
		.verse .he {
			font-family: Times New Roman;
			font-size: 36px;
			direction: rtl;
		}
		
		.verse:hover {
			background: #ddd;
		}
		
		.verse .clear {
			display: none;
		}
		
		.verse .lfc {
			font-size: 35px;
			font-variant: small-caps;
			margin: 0px 5px 0px 50px;
		}
		
		.verse.block {
			display: block;
			margin-bottom: 24px;
			line-height: 1.2;
		}
		
		.verse.block .en .lfc,
		#basetext.bilingual .verse .en .lfc  {
			font-size: inherit;
			font-variant: normal;
			margin: 0px;
		}
		

		#basetext.english {
			direction: ltr;
		}
		
		#basetext.english .verse .he{
			display: none;
		}
		
		#basetext.hebrew{
			direction: rtl;
			left: 4%;
			width: 58%;
			top: 85px;
		}
		
		#basetext.hebrew.noCommentary {
			left: 20%;
			margin-left: 0px;
			
		}
		#basetext.hebrew .he {
			display: inline;
		}
		
		#basetext.hebrew .en {
			display: none;
		}
		
		#basetext.bilingual .verse {
			display: block;
			clear: both;
			margin-bottom: 24px;
			line-height: 1.2;
		
		}
		
		#basetext.hebrew .verse .verseNum {
			right: -38px;
			left: auto;
		}	
		#basetext.heLeft .verse .verseNum {
			text-align: center;
			width: 4%;
			margin-left: -2%;
			left: 50%;
		}	
		
		#basetext.bilingual {
			left: 5%;
			width: 61%;
			top: 85px;
		}
		
		#basetext.bilingual.noCommentary,
		#basetext.bilingual.heLeft.noCommentary {
			margin-left: -34%;
			left: 50%;
			width: 68%;
			top: 127px;
		}
		
		#basetext.bilingual .verse .en {
			width: 48%;
			font-size: 20px;
			text-align: left;
			float: left;
		
		}
				
		#basetext.bilingual .verse .he {
			display: block;
			width: 48%;
			font-size: 27px;
			text-align: right;
			float: right;
			margin-left: 0px;
			direction: rtl;
			margin-top: -6px;
		}
		
		#basetext.bilingual.heLeft {
			left: 2%;
			width: 64%;
		}
		
		#basetext.bilingual.heLeft .verse .en {
			width: 47%;
			float: right;
			text-align: left;
			margin-right: 0px;
		
		}
				
		#basetext.bilingual.heLeft .verse .he {
			width: 47%;
			float: left;
			text-align: right;
			margin-left: 0px;
		
		}
		
		#basetext.bilingual .verse .clear {
			display: block;
		}
		
		.he {
			display: none;
			font-size: 27px;
			direction: rtl;
			margin-left: 7px;
		}
		
		.verseNum {
			font-size: 18px;
			width: 20px;
			text-transform: smallcaps;
			text-align: center;
			margin-right: 4px;
			margin-top: 5px;
			position: absolute;
			left: -38px;
			border-radius: 14px;
			-moz-border-radius: 14px;

		}
		
		.verse:hover > .verseNum {
			font-weight: bold;
			background: #ddd;
		}
		
		
		#next, #prev {
			text-align: right;
			font-size: 14px;
			cursor: pointer;
			margin: 4px 7px;
			padding-top: 7px;
			float: left;
		}
		
		#next:hover, #prev:hover {
			text-decoration: underline;
		}
		
		#commentaryBox {
			display: none;
			position: fixed;
			height: 100%;
			width: 29.5%;
			right: 1.5%;
			top: 72px;
			padding-left: 26px;
			border-left: 1px solid #bbb;
			overflow: hidden;
			text-overflow: ellipsis;
			font-family: serif;
			text-align: left;
			line-height: 1.1;
			background: inherit;
			z-index: 1;
			
		}
		

		#commentaryHeader {
			position: fixed;
			visibility: hidden;
			top: 69px;
			right: 2%;
			z-index: 10;
			border-radius: 3px;
			width: 31%;
			padding: 4px 6px;
			border: 1px solid #eee;
			-webkit-box-shadow: 2px 2px 3px #333333;
			-moz-box-shadow: 2px 2px 3px #333333;

		}
		
		#sourcesLink {
			font-size: 14px;
			float: right;
			cursor:pointer;
			margin-right: 3px;
		}
		
		#sourcesLink img {
			height: 14px;
			position: relative;
			top: 2px;
			margin-left: 2px;
		}
		
		
		#sourcesBox {
			display: none;
			position: fixed;
			right: 0%;
			width: 33.4%;
			z-index: 15;
			min-width: 130px;
			bottom: 0%;
			border-top-left-radius: 5px;
			padding: 0px;
			-webkit-box-shadow: 2px 2px 10px #555;
			-moz-box-shadow: 2px 2px 10px #555;	
			background: -moz-linear-gradient(top,  #f2f2f2,  #ddd);
			background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#f2f2f2), to(#ddd));
		}
			
		#sourcesBox.noCommentary {
			width: 175px;
		}


		#sourcesHeader {
			font-size: 15px;
			padding: 7px 7px 3px 7px; 
			border-bottom: 1px solid #999;
			cursor: pointer;
		}
		
		#sourcesBox.noCommentary #sourcesHeader {
			margin-bottom: 0px;
			padding: 0px 7px 0px 7px; 
			border-bottom: none;
		}
		
		#sourcesHeader #sourcesRange {
			font-style: italic;
		}

		#sourcesHeader #addSource {
			float: right;
			font-size: 14px;
			font-style: italic;
			cursor: pointer;
			margin: -3px 1px 0px 0px;
		}
		
		#sourcesHeader #addSource .textIcon,
		#aboutMenu .textIcon {
			font-weight: bold;
			font-size: 17px;
		}


		#sourcesList {
			display: none;
			padding: 3px 9px 7px 9px;
		}
		
		#sourcesList input {
			margin-left: 4px;	
		}
		
		
		.source {
			font-size: 18px;
			padding: 2px 11px 2px 2px; 
			max-width: 120px; 
			float: left;
			cursor: pointer;
		}
		
		.source .count {
			margin-left: 5px;
		}
		
		.source:hover {
			background: #f3f3f3;
		}


		.commentary {	
			font-family: serif;		
			display: block;
			background: #eee;
			font-size: 15px;
			max-height: 48px;
			padding: 2px 0px;
 			background: white;
			overflow: hidden;
			cursor: pointer;
			border-radius: 3px;
		}
		
		.commentaryNum {
			position: absolute;
			left: -10px;
			display: none;
		}
		
		.commentary + .commentary {
			margin-top: 15px;
		}
		
		.highlight {
			background: #e6e6e6;
		}
		
		.lowlight {
			opacity: 0.2;
		}
		
		.verse.lowlight:hover {
			background: #bbb;
		}
		
		.commentator {
			font-weight: bold;
			font-size: 17px;
			margin-right: 4px;
		}
		
		.anchorText {
			font-weight: bold;
			font-style: italic;
			margin-right: 7px;
		}
		

		.open {
		   	position: absolute;
			width: 580px;
			font-size: 20px;
		  	padding: 25px;
			background: white;
			z-index: 100;
			overflow: hidden;
			max-height: 466px;
			max-width: 100%;
			text-align: justify;
			line-height: 1.2;
			-webkit-box-shadow: 2px 2px 12px #333333;
			-moz-box-shadow: 2px 2px 12px #333333;
			
		}
		
		.open .refLink {
			cursor: pointer;
			font-weight: bold;
			text-decoration: underline;
			font-size: 14px;
		}
		
		.openVerseTitle {
			font-weight: bold;
			margin-bottom: 4px;
			margin-right: 10px;
			font-size: 16px;
			display: inline;

		}
		
		.openVerse {
			margin: 0px 0px 23px 0px;
			text-align: left;
			line-height: 1;
			font-style: italic;
			display: inline;
		}
		
		
		.open .editLink {
			color: #777;
			position: absolute;
			bottom: 20px;
			right: 26px;
			z-index: 10;
			font-size: 14px;
			cursor: pointer;
		}
		
		.open .editLink:hover {
			text-decoration: underline;
		}
		
		.scrollCtl {
			background: white;
			z-index: 5;
			position: absolute;
			top: 86%;
			left: 31%;
		}
		
		.scrollCtl img {
			height: 22.5px;
			width: 27px;
			cursor: pointer;
		}
		
		.scrollCtl .up { 
		}
		.scrollCtl .down { 
			position: relative;
			top: -2px;
			left: 20px;
		}
		
		.openScrollCtl {
			position: absolute;
			background: white;			
			height: 40px;
			bottom: 0px;
			text-align: center;
			width: 92%;
			vertical-align: bottom;
		}
		
		.openScrollCtl img {
			height: 26px;
			width: 30px;
			margin: 0px 10px;
			cursor: pointer;
			position: relative;
			top: 8px;
			
		}
		
		#cScrollCtl {
			display: none;
			position: absolute;
			right: 19%;
			top: 84%;
		}
		
		#cScrollCtl img {
			height: 16px;
			width: 19px;
			cursor: pointer;
		}
		
		#cScrollCtl .down {
			position: relative;
			top: -2px;
			left: 14px;
		}
		
		.openBottom {
			overflow: hidden;
		}
		
		#verseSelectModal {
			display: none;
		   	position: fixed;
		   	text-align: center;
			width: 27%;
			bottom: 40%;
			right: 1.5%;
			font-size: 24px;
		  	padding: 20px;
			border-radius: 10px;
			-moz-border-radius: 10px;
			z-index: 100;
			overflow: hidden;
			line-height: 1.2;
			-webkit-box-shadow: 2px 2px 12px #333333;
			-moz-box-shadow: 2px 2px 12px #333333;
			
		}
		
		#verseSelectModal .cancel {
			font-size: 16px;
		}

		
		#selectConfirm {
			display: none;
		}
		
		
		#selectedVerse {
			margin-top: 14px;
			font-weight: bold;
			font-size: 21px;
		}
		
		#selectedControls {
			margin-top: 20px; 
			font-size: 16px;
		}
		
		#selectedControls span {
			margin: 0px 8px;
			cursor: pointer;			

		}

		
		#selectedControls span:hover{
			text-decoration: underline;
		}

		
		.open .formRow {
			margin-bottom: 12px;
		}
		
		.open .label {
			font-size: 16px;
			display: inline;
			margin-right: 8px;
			font-weight: bold;
		}
		
		.open #anchorForm {
			width: 184px;
			float: right;
		}
		
		.open #anchorForm input {
			width: 180px;
		}

		
		.open #anchorInstructions {
			font-size: 14px;
		}
		
		.open .selectWord {
			cursor: pointer;
		}
		
		.open .selectWord:hover {
			color: blue;
		}
		
		.open input {
			width: 292px;
			border-radius: 3px;
			-moz-border-radius: 3px;
			-webkit-box-shadow: none;
			border: 1px solid grey;
			font-size: 13px;
			padding: 3px;

		}
		
		.open #sourceForm input {
			width: 392px;
		}
				
		.open textarea {
			width: 100%;
			height: 170px;
			line-height: 1.3;
			font-size: 15px;
			padding: 7px;
			border-radius: 3px;
			-moz-border-radius: 3px;
		}
		
		#addSourceControls {
			text-align: center;
			margin-top: 15px;
		}
		
		#addSourceControls .button {
			float: none;
			margin: 10px;
			display: inline;
		}
		
		#addModal {
			display: none;
		   	position: fixed;
			width: 560px;
			top: 120px;
			left: 50%;
			margin-left: -330px;
		  	padding: 15px 50px;
			border-radius: 10px;
			z-index: 100;
			overflow: hidden;
			text-align: justify;
			line-height: 1.2;
			-webkit-box-shadow: 2px 2px 12px #333333;
			-moz-box-shadow: 2px 2px 12px #333333;
			
		}
		

		
		#closeAdd {
			position: absolute;
			top: 8px; 
			right: 8px;
			font-size: 18px;
			font-family: sans-serif;
			cursor: pointer;
		}
		
		#addModal .header {
			font-size: 24px;
			font-weight: bold;
			margin: 10px 0px 20px 0px;;
		}

		#addModal .action {
			cursor: pointer;
			text-decoration: underline;
			color: #00aeef;
			letter-spacing: .8px;
		}
		
		#addModal .formRow {
			margin-bottom: 8px;
		}

		#addModal .label {
			width: 100px;
			min-height: 15px;
			float: left;
			text-align: right;
			margin: 0px 14px 0px 0px;
			font-size: 17px;
		}
		
		#addModal .button {
			display: inline;
			padding: 3px 12px;
			font-weight: normal;
			float: none;
			border-radius: 5px;
			-moz-border-radius: 5px;
			margin: 0px;
		}

		#addModal input {
			width: 60%
		}
		
		#addModal textarea {
			width: 100%;
			height: 210px;
			font-size: 18px;
		}
		
		
		#overlay {
			display: none;
			position: fixed;
			z-index: 20;
			background: black;
			opacity: 0.3;
			height: 100%;
			width: 100%;
			top: 0px;
			left: 0px;
		}
		
		#addVersionHeader {
			display: none;
			position: absolute;
			top: 63px;
			width: 100%;
			font-size: 18px;
		}
		
		
		#addVersionHeader input {
		 	width: 180px;
		 	margin: 0px 18px 0px 4px;
	
		}
		
		#addVersionHeader input#versionTitle {
			width: 290px;
		
		}

		#addVersionHeaderLeft {
			position: absolute;
			left: 5%;
			width: 39%;
			padding: 28px 12px;
			font-size: 19px;
		}
		
		
		.compareTitle {
			margin-bottom: 4px; 
		}
		.compareSource {
			font-size: 15px;
		}
		
		#addVersionHeaderRight {
			position: absolute;
			right: 5%;
			width: 42%;
			padding: 18px;
		}
				
		#addVersionHeaderRight div {
			margin-bottom: 6px;
			
		}

		
		.clear {
			clear: both;
		}
		
	</style>
	
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24447636-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
	<div id="overlay"></div>
	<div data-role="page">	
		<div data-role="header" data-position="fixed" id="top" class='gradient'>
			<div id="topButtons">
				<div id="viewButtons">
					<span id="open" class="button gradient" >Open</span>
				
					<span id="biLayoutToggle" class="toggle"><span id="heLeft" class="toggleOption gradient">Left</span><span id="enLeft" class="toggleOption gradient active">Right</span></span>
					
					<span id="layoutToggle" class="toggle"><span id="inline" class="toggleOption gradient active">Paragraphs</span><span id="block" class="toggleOption gradient">Lines</span></span>

					<span id="languageToggle" class="toggle"><span id="english" class="toggleOption gradient active">English</span><span id="bilingual" class="toggleOption gradient">Both</span><span id="hebrew" class="toggleOption gradient">Hebrew</span></span>

				</div>
				<div id="editButtons">
					<span id='addVersionCancel' class='button gradient'>Cancel</span><span class='button gradient'>Save</span>
				</div>
			</div>
			<div id="header"></div>
			<div class="clear"></div>

			<div id="gotoBox" class="gradient">
				<div class="dialogTitle">Open a book, chapter or verse:</div>
					<input id="goto" />
					<div id="openEg">e.g., Proverbs, Psalms 4, Leviticus 6:2</div>
			</div>
		</div>

		<div data-role="content">
			<div id="basetext" class="english"></div>
			<div data-position="fixed" id="commentaryBox"></div>
			
			<div id="sourcesBox">
				<div id="sourcesHeader">
					<b><span id="sourceCount"></span> Sources</b>
					<span id="addSource">Add source <span class="textIcon">+</span></span>
					<div class="clear"></div>
				</div>	
				<div id="sourcesList" class="gradient"></div>
			</div>
			
			
			<div id="verseSelectModal" class="gradient">	
				<div id="selectInstructions">
					<div>Click a verse to add a source.</div>
					<span class="cancel">Cancel</span>
				</div>
				<div id="selectConfirm">
					<div>Add a Source to:</div>
					<div id="selectedVerse"></div>
					<div id="selectedControls">
						<span id="selectOk">OK</span>
						<span id="selectReset">Choose again</span>
						<span class="cancel">Cancel</span>
					</div>
				</div>
			</div>

			<textarea id='newVersion'></textarea>
			<div id='newVersionMirror'/></div>
			
			<div id="addVersionHeader">
				<div id="addVersionHeaderLeft">
					<div class="compareTitle"></div>
					<div class="compareSource">Transcribed from www.jps.org</div>

				</div>
				<div id="addVersionHeaderRight">
					<div>Version Title: <input id="versionTitle"></div>
					<div>
						<select id="versionMethod">
						  <option value="transcription">Transcribed</option>
						  <option value="download">Downloaded</option>
						  <option value="copypaste">Copy and Pasted</option>
						  <option value="original">Original Translation</option>
						</select>
						
						from <input placeholder="a URL or book" id="versionSource">
					</div>
					<div>
					Language: 
						<select id="language">
						  <option value="en">English</option>
						  <option value="he">Hebrew</option>
						  <option value="ar">Aramaic</option>
						  <option value="ru">Russian</option>
						  <option value="es">Spanish</option>
						  <option value="fr">French</option>
						</select>
					</div>
				</div>
			</div>

		</div>
	</div>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.1.custom.min.js"></script>

<script type="text/javascript" src="/js/jquery.scrollTo-1.4.2-min.js"></script>
<script type="text/javascript" src="/js/jquery.easing.1.3.js"></script>
<script type="text/javascript" src="/js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="/js/jquery.caret.1.02.js"></script>


<script type="text/javascript">

/*!
 * jQuery TextChange Plugin
 * http://www.zurb.com/playground/jquery-text-change-custom-event
 *
 * Copyright 2010, ZURB
 * Released under the MIT License
 */
 (function(a){a.event.special.textchange={setup:function(){a(this).data("lastValue",this.contentEditable==="true"?a(this).html():a(this).val());a(this).bind("keyup.textchange",a.event.special.textchange.handler);a(this).bind("cut.textchange paste.textchange input.textchange",a.event.special.textchange.delayedHandler)},teardown:function(){a(this).unbind(".textchange")},handler:function(){a.event.special.textchange.triggerIfChanged(a(this))},delayedHandler:function(){var c=a(this);setTimeout(function(){a.event.special.textchange.triggerIfChanged(c)},
 25)},triggerIfChanged:function(a){var b=a[0].contentEditable==="true"?a.html():a.val();b!==a.data("lastValue")&&(a.trigger("textchange",[a.data("lastValue")]),a.data("lastValue",b))}};a.event.special.hastext={setup:function(){a(this).bind("textchange",a.event.special.hastext.handler)},teardown:function(){a(this).unbind("textchange",a.event.special.hastext.handler)},handler:function(c,b){b===""&&b!==a(this).val()&&a(this).trigger("hastext")}};a.event.special.notext={setup:function(){a(this).bind("textchange",
 a.event.special.notext.handler)},teardown:function(){a(this).unbind("textchange",a.event.special.notext.handler)},handler:function(c,b){a(this).val()===""&&a(this).val()!==b&&a(this).trigger("notext")}}})(jQuery);


	sjs = {
		cache: {},
		current: null,
		loading: false,
		flags: {
			verseSelecting: false
		},
		add: {source: null},
		elements: {
			$verses: null,
			$newVersion: null,
			$newVersionMirror: null,
		}
	}


	// ------------ List of Book names that can serve as a ref -------------------
		books = ["Amos", "Chronicles 1", "Chronicles 2", "Daniel", "Deuteronomy", "Ecclesiastes", "Esther", "Exodus", "Ezekiel", "Ezra Nehemiah", "Genesis", "Habakkuk", "Haggai", "Hosea", "Isaiah", "Jeremiah", "Job", "Joel", "Jonah", "Joshua", "Judges", "Kings 1", "Kings 2", "Lamentations", "Leviticus", "Malachi", "Nahum", "Numbers", "Obadiah", "Proverbs", "Psalms", "Ruth", "Samuel 1", "Samuel 2", "Song of Songs", "Zechariah", "Zephaniah"]

		palette = ["#00681C", "#C88900", "#5B1094", "#790619", "#CC0060", "#008391", "#009486"];
	
	// --------------- Track First and Last Visible Verses -----------------
	
		firstVisible = new Object();
		lastVisible = new Object();
		
		book = "Genesis"
		chapter = "1"

		firstVisible.chapter = 1;
		firstVisible.verse = 1;
		lastVisible.chapter = 1;
		lastVisible.verse = 1;

	$(function() {
	
	
	// ----------- Stored Elements ---------------
		
		
		sjs.elements.$newVersion = $("#newVersion")
		sjs.elements.$newVersionMirror = $("#newVersionMirror")
		
	// ------------iPad Fixes ---------------------
		
		if (isTouchDevice()) {
			//$("#commentaryBox").css("height", "auto");
		}
			

	
	// ---------------- Handle Hash Change ----------------
	
		$(window).hashchange( function(){
			if (location.hash == "") {
				$("#header").html("Genesis")
				get(parseQuery("Genesis.1.1"));
			} else {
				get(parseQuery(location.hash.substr(2)))
			}
		})
		
		$(window).trigger("hashchange")
	
	
	// ------------- Hide Modals on outside Click -----------
	
		$(window).click(function() {
			$("#gotoBox").hide()
			$("#aboutMenu").hide()
			// $("#sourcesList").hide()
			$(".open").remove()
			$("#overlay").hide()
			lowlightOff();
		})
	
	// ------------- Top Button Handlers -------------
		
		$("#about").live("click", function() {
			$("#aboutMenu").show()
			return false;
		})
	
	
		$("#open").live("click", function() {
			$("#gotoBox").show()
			$("#goto").focus();
			return false
		})
		
		$("#gotoBox").click(function() {
			return false;
		})
				
	// ---------------- Sources List ---------------
	
		
		$("#sourcesHeader").live("click", function() {
		
			if ($("#sourcesList").is(":visible")) {
				$("#sourcesList").hide()
			} else {
				$("#sourcesList").show()
			}
		})
		
		$(".source").live("click", function() {
			var c = $(".cName", this).text()
			
			if (!$(".source.lowlight").length){
				$(".source").addClass("lowlight")
				$(".commentary").hide()
			
			}
			
			if ($(this).hasClass("lowlight")) {
				$(this).removeClass("lowlight")
				$(".commentator:contains('" + c + "')").parent().show()
			} else {
				$(this).addClass("lowlight")
				$(".commentator:contains('" + c + "')").parent().hide()
			}
			return false
		})
		
	// --------------- Ref Links in Sources Text -------------------
	
		$(".open .refLink").live("click", function() {
			var ref = $(this).attr("data-ref");
			location.hash = refHash(parseQuery(ref));
		})
	
	// --------------- Add Version ------------------
	
		$("#addVersion").live("click", function() {
			$("#commentaryBox").hide()
			$("#sourcesBox").hide()
			$("#aboutMenu").hide()
			$("#prev, #next").remove()
			$("#basetext").addClass("versionCompare")
			$(".verse").addClass("block").unbind("click")
			
			$("#newVersion").height($("#basetext").height()).show().focus()

			
			$(".compareTitle").text($("#aboutTitle").text())
			
			$("#header").text("Add a version of " + sjs.current.book + " chapter " + sjs.current.chapter)
			$(window).unbind("scroll")
			
			$("#viewButtons").hide()
			$("#editButtons").show()
			
			sjs.elements.$verses = $(".verse")
						
			$("#addVersionCancel").click(function() {

				buildView(sjs.current)
				
			})
			
			$("#addVersionHeader").show()
			
			$("#newVersion").bind("textchange", checkTextDirection)
			$("#newVersion").bind("keyup", handleTextChange)

			
			
			return false;
			
		
		})
		
		function handleTextChange(e) {
		
			if (e.keyCode == 8) {
				var cursor = sjs.elements.$newVersion.caret().start
				
				if (cursor) {
					var text = sjs.elements.$newVersion.val()
					
					while (text[cursor] == "\n") cursor++
					
					var newLines = 0;
					while (text[cursor-newLines-1] == "\n") newLines++
					
					if (newLines) {
						text = text.substr(0, cursor-newLines) + text.substr(cursor)
						sjs.elements.$newVersion.val(text)
							.caret({start: cursor-newLines, end: cursor-newLines})
					}
	
				}
				
				
				
			
			}
		
			syncTextGroups()

		}

		
		function checkTextDirection() {
			var text = $(this).val()
			if (text == "") return
			
			var heCount = 0;
			var enCount = 0;
			
			for (var i = 0; i < 20; i++) {
				if (i >= text.length) break;
				if ((text.charCodeAt(i) > 0x590) && (text.charCodeAt(i) < 0x5FF)) {
					heCount++
				} else {
					enCount++
				}
			}
			
			if (heCount > enCount) {
				$(this).css("direction", "rtl")
				$("#language").val("he")
				
			} else {	
				$(this).css("direction", "ltr")
				$("#language").val("en")

			}
		}
	
	// ------------- Next Link Url -----------------
	
		$("#next, #prev").live("click", function() {
			var ref = $(this).attr("data-ref");
			location.hash = refHash(parseQuery(ref));
		})
	
	
	// ---------------- Layout Options ------------------
		
		$("#block").live("click", function(){
			$("#layoutToggle .toggleOption").removeClass("active")
			$(this).addClass("active")
			$(".verse").addClass("block")
			
		})
		
		$("#inline").live("click", function(){
			$("#layoutToggle .toggleOption").removeClass("active")
			$(this).addClass("active")
			$(".verse").removeClass("block")
		})
	
	// ------------------ Language Options ---------------
	
		$("#hebrew").live("click", function(){
			$("#languageToggle .toggleOption").removeClass("active")
			$(this).addClass("active")
			$("#basetext").removeClass("english bilingual heLeft")
				.addClass("hebrew")
			$("#layoutToggle").show()
			$("#biLayoutToggle").hide()
		})
		
		$("#english").live("click", function(){
			$("#languageToggle .toggleOption").removeClass("active")
			$(this).addClass("active")
			$("#basetext").removeClass("hebrew bilingual heLeft")
				.addClass("english")
			$("#layoutToggle").show()
			$("#biLayoutToggle").hide()
		})
		
		$("#bilingual").live("click", function() {
			$("#languageToggle .toggleOption").removeClass("active")
			$(this).addClass("active")
			$("#basetext").removeClass("english hebrew")
				.addClass("bilingual heLeft")
			$("#layoutToggle").hide()
			$("#biLayoutToggle").show()
			
		})
		
		$("#heLeft").live("click", function() {
			$("#biLayoutToggle .toggleOption").removeClass("active")
			$(this).addClass("active")
			$("#basetext").removeClass("english hebrew")
				.addClass("bilingual heLeft")
			
		})
	
		$("#enLeft").live("click", function() {
			$("#biLayoutToggle .toggleOption").removeClass("active")
			$(this).addClass("active")
			$("#basetext").removeClass("english hebrew heLeft")
				.addClass("bilingual")
			
		})
	
	
	// ---------------------- Commentary Modal --------------------------
		
		$(".commentary").live("click", function(e){
			if ($(this).hasClass("lowlight")) {
				lowlightOff();
			}
			buildOpen($(e.currentTarget))
			return false;
		});
		

	
	// ----------------------- Commentary Edit --------------------
	
		$(".editLink").live("click", function () {
			var source = {}
			
			source["id"] = parseInt($(this).parent().attr("data-id"))
			source["ref"] = sjs.current.book + " " + sjs.current.chapter + ":" + $(this).parent().attr("data-ref")
			
			sjs.add.source = source
			buildOpen(false, true)
		})
	
		
	// ------------------- Commentary Model Hide ----------------------

		$(".open").live("click", function(e){
			//$(".open").remove()
			//$("#overlay").hide()
			return false
		})
		
	// -------------------- Update Commentary --------------------
		
		function updateCommentary() {
						
			for ( var i = firstVisible.verse; i <= lastVisible.verse; i++ ) {
				$(".commentary[data-ref=1:" + (i+1) + "]").each(function(i) {
					$(this).appendTo("#commentaryBox");
				});
			}
			
			$("#commentaryBox").fadeIn(1200);
			
			if (overflows($("#commentaryBox"))) {
				$("#cScrollCtl").fadeIn(100);
			}
			
			function hideCommentary() {
				$("#commentaryBox").fadeOut(100, function() {
					$("#commentaryBox .commentary").appendTo("#commentaryBuffer");
				});
				$("#cScrollCtl").fadeOut(100);

			}
			
		}
	


	// -------------------- Open Text Scrolling --------------------

		$(".openScrollCtl .up").live("click", function(e) {
			$b = $(".openBottom");
			var h = $b.height();
			var lh = parseInt($b.css("line-height"));
			h -= h % lh;
			$b.scrollTo("-=" + h + "px", 600, {easing: "easeOutExpo"});
			return false;
		});
		$(".openScrollCtl .down").live("click", function(e){
			$b = $(".openBottom");
			var h = $b.height();
			var lh = parseInt($b.css("line-height"));
			h -= h % lh;
			$b.scrollTo("+=" + h + "px", 600, {easing: "easeOutExpo"});
			return false;
		});

	// -------------- Commentary Scrolling -------------- 
		function cbScroll(d) {
			$cb = $("#commentaryBox")
			var h = $cb.height();
			var ds = (d == 1 ? "+=" : "-=");
			$cb.scrollTo(ds + h, 900, {easing: "easeOutExpo"})
		}

		$("#cScrollCtl .up").click(function(){
			cbScroll(-1);
		})
	
		$("#cScrollCtl .down").click(function() {
			cbScroll(1);
		})

	// -------------- Highlight Verse on Commentary Hover -------------- 
	

	/*$(".commentary").live("mouseenter", function (e) {
		
		if(typeof(offTimeout) != "undefined") clearTimeout(offTimeout)
		$c = $(e.currentTarget);
		var ref = $c.attr("data-ref");
		var verse = parseInt(ref) - 1;
		
		onTimeout = setTimeout("lowlightOn(" + verse + ")", 300)
	
	})
	$(".commentary").live("mouseleave", function (e) {
		if(typeof(onTimeout) != "undefined") clearTimeout(onTimeout)
		offTimeout = setTimeout("lowlightOff()", 300)
	})
*/
	// -------------- Highlight Commentary on Verse Click -------------- 

	$(".verse").live("click", function (e) {
		lowlightOff();
		var v = $(this).index() ;		
		lowlightOn(v)

		if (sjs.flags.verseSelecting) {
			var verse = sjs.current.book + " " + sjs.current.chapter + ":" + (v+1)
			sjs.add.source = {ref: verse}
			$("#selectedVerse").text(verse)
			$("#selectConfirm").show()
			$("#selectInstructions").hide()
		}


		var $comments = $("#commentaryBox .commentary[data-ref=" + (v+1) + "]")
		var $fc = $comments.eq(0);
		
		if ($fc.length == 1) {
			$("#commentaryBox").clearQueue();
			$("#commentaryBox").scrollTo($fc, 600, {easing: "easeOutExpo"});
		}
		return false;
	})
	
	
	// --------------- Add ------------------------
	
	$("#addSource").click(function(){
		$("#commentaryBox").hide()
		$("#sourcesBox").hide()
		$("#verseSelectModal").show()
		$("#selectConfirm").hide()
		$("#selectInstructions").show()
		sjs.flags.verseSelecting = true
		
		return false
	})
	$("#addSourceCancel").live("click", function() {
		$(".open").remove()
		$("#overlay").hide()
		
	})
	
	$("#addModal").click(function() {
		return false;
	})
	
	// --------------- Verse Select ----------------
	
	$("#selectVerse").click(function() {
		$("#addModal, #overlay").hide()
		$("#commentaryBox").hide()
		$("#sourcesBox").hide()
		$("#verseSelectModal").show()
		sjs.flags.verseSelecting = true
		
	})
	
	$("#verseSelectModal #selectOk").click(function() {
		$("#overlay").show()
		buildOpen()
		$("#commentaryBox").show()
		$("#sourcesBox").show()
		$("#verseSelectModal").hide()
		lowlightOff()
		sjs.flags.verseSelecting = false
		return false
		
	})
	
	$("#selectReset").click(function() {
		$("#selectInstructions").show()
		$("#selectConfirm").hide()
	
	})
	
	$("#verseSelectModal .cancel").click(function() {
		$("#verseSelectModal").hide()
		$("#sourcesBox").show()
		if (sjs.current.commentary) $("#commentaryBox").show()
	
	})

	// ------------- Nav Queries -----------------

	
			
	$("#goto").keypress(function(e) {
			if (e.keyCode == 13) {
				q = parseQuery($("#goto").val());
				var ref = "/" + q.book;
				if (q.chapter) {
					ref += "." + q.chapter;
				}
				if (q.verse) {
					ref += "." + q.verse;
				}
				location.hash = ref;
			}
		})
		
	$("input#goto").autocomplete({ source: books });
		
		
});

	function get(q) {
			if ($.inArray(q.book, books) < 0) {
				$("#header").html("Unknown book: <i>" + q.book + "</i>")
				return
			}
			
			sjs.loading = true
			$("#header").html(q.book + " <img id='loadingImg' src='/img/ajax-loader.gif'/>")


			var getStr = "/get.py?book=" + q.book
			if (q.chapter) {
				getStr += "&chapter=" + q.chapter
			}
			if (q.verse) {
				getStr += "&verse=" + q.verse
			}
			if (q.toChapter) {
				getStr += "&toChapter=" + q.toChapter
			}
			if (q.toVerse) {
				getStr += "&toVerse=" + q.toVerse
			}
			$("#layoutToggle").hide()
			$("#languageToggle").hide()
			$("#commentaryBox").empty().hide()
			$("#gotoBox").hide()
			$("#goto").val("")
			$("#sourcesBox").hide()
			$("#sourcesList").empty()
			$(".open").remove()
			$("#overlay").hide()
			$("#basetext").removeClass("noCommentary").html("")
			$("#sourcesBox").removeClass("noCommentary")
			$("#next").remove()
			$("#prev").remove()

			var ref = q.book + "." + q.chapter
			if (ref in sjs.cache) {
				buildView(sjs.cache[ref])
			} else {
				$.getJSON(getStr, buildView)	

			}
			
	}


	function buildView(data) {
			$("#basetext").empty().removeClass("noCommentary versionCompare")
			$("#sourcesBox").removeClass("noCommentary")
			$("#commentaryBox").empty()
			$("#addVersionHeader").hide()
			$("#newVersion").hide()
			$("#editButtons").hide()
			$("#viewButtons").show()
			$("#next").remove()
			$("#prev").remove()
			
			if (data.error) {
				$("#header").html(data.error);
				return;
			}
			
			sjs.cache[data.book + "." + data.chapter] = data
			sjs.current = data
			
			book = data.book;
			chapter = data.chapter;
			$("#header").html(data.title)
			
			if (data.he) {
				$("#languageToggle").show()
			} else {
				$("#languageToggle").hide()
				$("#english").trigger("click")

			}
			
			$("#layoutToggle").show()
			
			for (var i = 0; i < data.text.length; i++) {
				var verse = "<span class='en'>" + data.text[i] + "</span>"
				if (data.he) {
					verse += "<span class='he'>" + data.he[i] + "</span><div class='clear'></div>"
				}
				$("#basetext").append("<span class='verse'>" + verse + "</span>")

			}
			// Window Resize Handlers
						
			$(window).resize(function() {
				lowlightOff();
				updateVisible();
			})
			
			$(window).scroll(function() {
				//lowlightOff();
				updateVisible();
			})

			
			$("#basetext").append("<div class='clear'></div>")
			
			
			// Prefetch Next and Prev
			if (data.next) {
				prefetch(data.next)
				$("#header").after("<div id='next' data-ref='" + 
										data.next + "'>Chapter " + 
										(data.chapter +1) + " &#0187;</div>")
			}
			
			if (data.prev) {
				prefetch(data.prev)
				$("#header").after("<div id='prev' data-ref='" + 
										data.prev + "'>&#0171; Chapter " + 

										(data.chapter - 1) + "</div>")
			}
			
			
			makeLargeFirstChar() 
			
			
			// Verse Numbers
			$(".verse").each(function(){
				var n = $(this).index() + 1;
				$(this).prepend("<div class='verseNum'>" + n + "</div>")
				//$(".verseNum").last().css("top", $(this).position().top-3)
			})
			
			if (data.verse > 1) {
					$(window).scrollTop($(".verse").eq(data.verse - 1).position().top - 200);
					lowlightOn(data.verse - 1, data.toVerse - 1);
			}
		
			// Parse Commentary into CommentaryBox
			if (data.commentary) {
				$("commentaryBox").hide()
				$("#sourcesList").empty()
				var colorAssignments = {}
				sourceCounts = {}	

				var n = 0;
				for (var i = 0; i < data.commentary.length; i++) {
					c = data.commentary[i]
					if (typeof(c.anchorText) == "undefined") {c.anchorText = ""}
				
					refReStr = "(" + books.join("|") + ") (\\d+):(\\d+)"
					refRe = new RegExp(refReStr, "g")
					var text = String(c.text)						
					c.text = text.replace(refRe, "<span class='refLink' data-ref='$1.$2.$3'>$1 $2:$3</span>")
					
					$("#commentaryBox").append("<span class='commentary' data-ref='" + c.refVerse + 
					"' data-id='" + c.id +
					"' data-source='" +c.source +
					"'><span class='commentator'>" + c.commentator + ":</span><span class='anchorText'>" + c.anchorText + 
					"</span><span class='text'>" + c.text + "</span></span>")
					
					// Give each Commentator a Color
					var color;
					if (!(c.commentator in colorAssignments)) {
						colorAssignments[c.commentator] = n
						sourceCounts[c.commentator] = 0
						$("#sourcesList").append('<div class="source" data-commentator="'+c.commentator+'"><span class="cName">'+
						c.commentator+'</span><span class="count"></div>')
						n++
					}
					
					color = palette[colorAssignments[c.commentator]];
					$(".commentator").last().css("color", color)
				
					sourceCounts[c.commentator]++
					
					//Commentary verse numbering
					//$(".commentary").last().prepend("<span class='commentaryNum'>" + c.refVerse + "</span>")
				
				}
				

				$("#sourcesList").append("<div class='clear'></div>")

				
				// Build source counts
				var sourceTotal = 0
				for (commentator in sourceCounts) {
					$(".count", '.source[data-commentator="'+commentator+'"]').text("("+sourceCounts[commentator]+")")
					sourceTotal += sourceCounts[commentator]
				
				}
				
				$("#sourceCount").text(sourceTotal)
				
				// Sort by data-ref
				var $cb = $('#commentaryBox');
				var $comments = $cb.children(".commentary").get();
				$comments.sort(function(a, b) {

				   var compA = parseInt($(a).attr("data-ref"))
				   var compB = parseInt($(b).attr("data-ref"))
				   return (compA < compB) ? -1 : (compA > compB) ? 1 : 0;
				})
				$.each($comments, function(idx, itm) { $cb.append(itm); });
				$("#commentaryBox").show();										
			} else {
				$("#sourceCount").text("0")
				$("#basetext, #sourcesBox").addClass("noCommentary")
			}
			$("#sourcesRange").html($("#header").text().split(":")[0])
			$("#sourcesBox").show()	
			
			sjs.loading = false
			updateVisible();
		}
	
		//  -------------------- Update Visible Verse --------------------------
	
		function updateVisible() {
			if (sjs.loading) {
				return
			}
			var $v = $(".verse"); 
			var $w = $(window);
			var l = $v.length;
			
			for (var i = 0; i < l; i++) {
				var top = parseInt($v.eq(i).offset().top);
				var wtop = parseInt($w.scrollTop());
				if (top - wtop >= 80) {
					if (firstVisible.verse != i) {
						firstVisible.verse = i+1;
						var $comments = $("#commentaryBox .commentary[data-ref=" + i + "]")
						if ($comments.eq(0).length == 1) {
							$("#commentaryBox").clearQueue();
							$("#commentaryBox").scrollTo($comments.eq(0), 600)
						}
					}
					break;
				}
			}

			for (i = i; i < l; i++) {
				var bottom = $v.eq(i).offset().top + $v.eq(i).outerHeight();
				var wbottom = $w.height() + $w.scrollTop(); 
				if (bottom > wbottom) {
					if (lastVisible.verse != i) {
						lastVisible.verse = i + 1;					
					}
					break;	

				}
			}
			
			$("#header").html(sjs.current.book + " " + sjs.current.chapter + ":" + firstVisible.verse + "-" + lastVisible.verse)
			$("#header").append("<span id='about'>about this text <span class='ui-icon-triangle-1-s ui-icon'></span>" +
						"<div id='aboutMenu' class='gradient'><div id='aboutTitle'>" + sjs.current.versionTitle + "</div>" +
						"<div id='aboutSource'>Source: www.outhere.com/somewhere/234</div>" +
						"<div class='action'>Edit text</div>" + 
						"<div id='addVersion' class='action'>Add version <span class='textIcon'>+</span></div>" + 
						"<div class='action'>Add new text <span class='textIcon'>+</span></div>" +
						"<div></div></span>") 


		
		}
	
		// ---------------- Large First Character ------------
	
	function makeLargeFirstChar() {
		var $fv = $(".verse:first .en")
		var text = $fv.text();
		var words = text.split(" ")
		$fv.empty()
		$fv.append("<span class='lfc'>" + words[0] + " " + words[1] + " " +words[2] +  "</span>")
		words.shift()
		words.shift()
		words.shift()
		
		var rest = " " + words.join(" ")
		$fv.append("<span>" + rest + "</span>")
	}
	
	
		function parseQuery(q) {
		var response = {book: false, chapter: false, verse: false, to: false, toChapter: false, toVerse: false}
		
		var q = q.replace(/[.:]/g, " ")
		var toSplit = q.split("-")
		var p = toSplit[0].split(" ")
		var offset = 0;
		if (p[0] in {Ezra: 1, Kings:1, Samuel: 1, Chronicles: 1}) {
			response.book = p[0][0].toUpperCase() + p[0].substr(1)  + " " + p[1][0].toUpperCase() + p[1].substr(1)
			offset = 1;
		} else if (p[0] in {Song: 1, song: 1}) {
			response.book = p[0][0].toUpperCase() + p[0].substr(1) + " " + p[1]  + " " + p[2][0].toUpperCase() + p[2].substr(1);
			offset = 2;
		} else {
			response.book = p[0][0].toUpperCase() + p[0].substr(1)
		}
		
		if (typeof(p[1+offset] != "undefined")) response.chapter = p[1+offset]
		if (typeof(p[2+offset] != "undefined")) response.verse = p[2+offset]
		
		if (toSplit.length == 2) {
			var cv = toSplit[1].split(" ")
			if (cv.length == 2) {
				response.toChapter = cv[0]
				response.toVerse = cv[1]
			} else if (cv.length == 1) {
				response.toVerse = cv[0]
				response.toChaptere = response.chapter
			}
		}
		
		return response;
	}
	
	
	function buildOpen ($c, editMode) {
		
		if (editMode) {
			var commentator = $(".open .commentator").text().substr(0, $(".open .commentator").text().length - 1)
			var text = $(".open .text").text()
			var anchorText = $(".open .anchorText").text()
			var source = $(".open").attr("data-source")
			$("#selectedVerse").text($(".open .openVerseTitle").text())
		}
		
		$(".open").remove()
		
		if ($c) {
		// building a modal to read
			$c.clone().hide().appendTo("body")
				.removeClass("commentary").addClass("open")
			
			var $o	= $(".open");
			var v = parseInt($o.attr("data-ref"))
			
			// prefetch ref links 
			$(".refLink", $o).each(function() {
				prefetch($(this).attr("data-ref"))	
			})
			
		} else {
		// building an editing modal
			$("body").append("<div class='open'></div>")
			$o = $(".open")
			var ref = $("#selectedVerse").text()
			var v = ref.split(":")[1]
			
			var html = 	'<div class="formRow" id="anchorForm"><div class="label">Anchor Words:</div><br>' +
				'<input placeholder="click words above to choose"></div>' +
				'<div id="commentatorForm" class="formRow"><div class="label">Commentator or Text Title:</div><br>' +
				'<input placeholder="e.g., Rashi, Brachot 32a, Bereshit Rabbah 3:4"></div>' +
				'<div id="textForm" class="formRow"><div class="label">Text:</div><textarea></textarea></div>' +
				'<div id="sourceForm" class="formRow"><div class="label">Source:</div><input placeholder="The book or website this text was copied from"></div>' +
				'<div id="addSourceControls"><span id="addSourceSave" class="button">Add</span><span id="addSourceCancel" class="button">Cancel</span></div>'

			$o.append(html)
			$("#addSourceSave").click(handleSave)
			
			$o.css("max-height", "550px")
	
		}
		
		if (editMode) {
			$("#commentatorForm input").val(commentator)
			$("#anchorForm input").val(anchorText)
			$("#textForm textarea").val(text)
			$("#sourceForm input").val(source)

			$("#addSourceSave").text("Save")
		}
		
		
		var verse = $(".verse").eq(v-1).text();
		var trim = isInt(verse[1]) ? 2 : 1;
		verse = verse.substr(trim)
		$(".open").prepend("<br><br>")
		$(".open").prepend("<div class='openVerse'>"+verse+"</div>");
		var title = $("#header").html()
		title = title.split(":")
		title = title[0] + ":" + v
		$(".open").prepend("<div class='openVerseTitle'>"+title+"</div>");

		
		var h = $o.height();
		var w = $o.width();
		var mh = parseInt($o.css("max-height"));
		var p = parseInt($o.css("padding-top"));
		var pl = parseInt($o.css("padding-left"));
		var wh = $(window).height();
		var ww = $(window).width();

		if (h + (2*p) >= mh) {
			$o.wrapInner("<div class='openBottom' />");
			$o.children().eq(0).height(h - p)
			$o.append('<div class="openScrollCtl"> \
				<img src="/img/up.png" class="up"/> \
				<img src="/img/down.png" class="down"/> \
			</div>');
		} else {
			
		}
		
		$o.css("top", $(window).scrollTop() + (wh - (h+(2*p))) / 2.2 + "px");
		$o.css("left", (ww - (w+(2*pl))) / 2 + "px");
		
		if ($c) {
		
			$o.append("<div class='editLink'>Edit</div>")	
		
		} else {
		//select anchor words	
		 	var words = verse.split(" ")
		 	
		 	var html = ""
		 	for (var i = 0; i < words.length; i++) {
		 		html += '<span class="selectWord">' + words[i] + "</span> "
		 	}
		 	 
		 	 html = $.trim(html)
		 	 
			$(".openVerse").html(html)
		
		
			$(".selectWord").click(function() {
			
				if (!$(".selectWord.lowlight").length){
					$(".selectWord").addClass("lowlight")				
				}
				
				if ($(this).hasClass("lowlight")) {
					$(this).removeClass("lowlight")
				} else {
					$(this).addClass("lowlight")
				}
			
				var anchorWords = ""
			
				$(".selectWord").each(function() {
					if (!$(this).hasClass("lowlight")) {
						anchorWords += $(this).text() + " "
					}
				})
				
				$("#anchorForm input").val(anchorWords)
				})
				
				return false

		}
		
		$o.show();
		$("#overlay").show()
		return false
	}
	
	function readSource() {
		
		var source = sjs.add.source || {}
	
		source["commentator"] = $("#commentatorForm input").val()
		source["anchorText"] = $("#anchorForm input").val()
		source["text"] = $("#textForm textarea").val()
		source["source"] = $("#sourceForm input").val()

		// TODO language detection
		source["language"] = "en"
		
		sjs.add.source = source
		
		return source
		
	}
	
	function handleSave() {
		var source = readSource()
		
		// TODO validaite source
		
		
		saveSource(source)
	}
	
	function saveSource(source) {
	 	postJSON= JSON.stringify(source);
 	
		$.post("save.py", {"json": postJSON}, function(data) {
			if (data) {
				$(".open").remove()
				$("#overlay").hide()
				
				if (!sjs.current.commentary) {
					sjs.current.commentary = [data]
				} else {
					
					for (var i = 0; i < sjs.current.commentary.length; i++) {
						if (sjs.current.commentary[i].id == data.id) {
							sjs.current.commentary.splice(i, 1)
						}
					}
					sjs.current.commentary.push(data)

				}
				buildView(sjs.current)
			} else {
				alert("Sorry, there was a problem saving your source")
			}
		})
	}
	
	
	function makeRef(q) {
		var ref = q.book;
		if (q.chapter) {
			ref += "." + q.chapter;
		}
		if (q.verse) {
			ref += "." + q.verse;
		}
		if (q.toChapter) {
			ref += "-" + q.toChapter + "." + q.toVerse
		} else if (q.toVerse) {
			ref += "-" + q.toVerse
		}
		
		return ref
	}
	
	function refHash(q) {
		return "/" + makeRef(q);
	}


// Check if a div is overflowing
// TODO: don't assume $div is absolute

	function overflows($div) {
		var h = $div.height();
		var $children = $div.children();
		for ( var i = 0; i < $children.length; i++) {
			if ($children.eq(i).position().top > h ) {
				return true;
			}
		}
		return false;
	}

// Determine is an element is scroll visible
// TODO: don't assume the parent is the scroll window

	function isScrollVis($div) {
		var t = $div.offset().top
		var h = $div.parent().outerHeight();
		var pt = $div.parent().offset().top;
		
		if (t < pt) return false;
		if (t > pt + h) return false;
		
		return true;	
	}


	function heightAtChar(n) {
	// Not fully working
		n++
		var text = $("#newVersion").val()
		text = text.substr(0,n) + "<span id='heightMarker'/>" + text.substr(n)
		text = text.replace(/\n/g, "<br>")
		sjs.elements.$newVersionMirror.html(text).show()
		
		var top = $("#heightMarker").offset().top
		
		$("#newVersionMirror").hide()
		
		$("#dot").remove()
		
		$("<div id='dot'/>").appendTo("body")
			.css({"position": "absolute", 
				"height": "10px",
				"width": "10px",
				"left": "50%",
				"background": "red",
				"top": top})
		return top;
		
		
		
	}
	
	function heightAtGroup(n) {
	
	
		var text = sjs.elements.$newVersion.val()
				
		text = "<span class='heightMarker'>" + text
		text = text.replace(/(\n+)([^\n])/g, "</span>$1<span class='heightMarker'>$2")
		text = text.replace(/\n/g, "<br>")
		text = text + "</span>"


		sjs.elements.$newVersionMirror.html(text)
		
		if (n >= $(".heightMarker").length) return false;

		
		sjs.elements.$newVersionMirror.show()
		
		var top = $(".heightMarker").eq(n).offset().top
		
		sjs.elements.$newVersionMirror.hide()
		
		return top;
		
		
		
	}

	function syncTextGroups() {
		
		
		var verses = sjs.elements.$verses.length
	
		for (var i = 1; i < verses; i++) {

		
			vTop = sjs.elements.$verses.eq(i).offset().top
			
			tTop = heightAtGroup(i)
			
			if (!tTop) return
			

			
			if (vTop < tTop) {
				
				var marginBottom = parseInt(sjs.elements.$verses.eq(i-1).css("margin-bottom")) + (tTop-vTop)
				
				sjs.elements.$verses.eq(i-1).css("margin-bottom", marginBottom + "px")
				
				
			} else if (tTop < vTop) {
				
				if (parseInt(sjs.elements.$verses.eq(i-1).css("margin-bottom")) > 24) {
					sjs.elements.$verses.eq(i-1).css("margin-bottom", "24px")
					i--
					continue
				}
				
				
				var text = sjs.elements.$newVersion.val()
				
				var regex = new RegExp("\n+", "g")
					
				for (var k = 0; k < i; k++) {
					var m = regex.exec(text)
				}
				
				text = text.substr(0, m.index) + "\n" + text.substr(m.index)
				
				var cursorPos = sjs.elements.$newVersion.caret().start
				sjs.elements.$newVersion.val(text)
					.caret({start: cursorPos+1, end: cursorPos+1})
				
				
				i--
				
			}
		
		
		}
	
	
	}

	function readNewVersion() {
		
		var version = {}
	
		version["title"] = sjs.current.book
		version["chapter"] = sjs.current.chapter
	
		var text = $("#newVersion").val();
		var verses = text.split(/\n\n+/g)
		
		version["verses"] = verses
		version["language"] = $("#language").val()
		version["versionTitle"] = $("#versionTitle").val()
		version["method"] = $("#versionMethod").val()
		version["source"] = $("#versionSource").val()
		
		return version
		
	}
	
		
	function saveText(text) {
	 	postJSON= JSON.stringify(text);
 	
		$.post("save.py", {"json": postJSON}, function(data) {
			if (data) {
				alert("It seems to have worked.")
			} else {
				alert("Sorry, there was a problem saving your source")
			}
		})
	}

	function prefetch(ref) {

		ref = ref.replace(/[ :]/g, ".")
		if (ref in sjs.cache) return	
	
		$.getJSON("/get.py?ref=" + ref, function(data) {
		
			if (data.error) return
			
			sjs.cache[data.book + "." + data.chapter] = data
		})
	}

	function lowlightOn(n, m) {
		
		m = m || n
		
		$c = $("#commentaryBox .commentary[data-ref="+ (n+1) + "]")
		$(".commentary").addClass("lowlight")
		$c.removeClass("lowlight")
		$(".verse").addClass("lowlight" )
		$(".verse").each(function() {
			if (n <= $(this).index() && $(this).index()  <= m) {
				$(this).removeClass("lowlight")
			}
		});
	}
	

	function lowlightOff() {
		$(".commentary").removeClass("lowlight")
		$(".verse").removeClass("lowlight")
	}

	function isTouchDevice() {  
	  try {  
	    document.createEvent("TouchEvent");  
	    return true;  
	  } catch (e) {  
	    return false;  
	  }  
	}

	function isInt(x) {
   		var y=parseInt(x);
   		if (isNaN(y)) return false;
   		return x==y && x.toString()==y.toString();
 	}

	</script>
	
</body>
</html>
