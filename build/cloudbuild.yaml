steps:
  # Monitor doesn't need node.  Build and push that first.
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/production-deployment/multi_monitor:$TAG_NAME", "-f", "build/monitor/Dockerfile", "."]
  - name: 'gcr.io/cloud-builders/docker'
    args: ["push", "gcr.io/production-deployment/multi_monitor:$TAG_NAME"]

  # Install npm dependencies, and build bundles.
  - name: 'debian'
    args: ['cp', 'build/node/local_settings.json', 'node/local_settings.json']
  - name: 'gcr.io/cloud-builders/npm'
    args: ['install']
  - name: 'gcr.io/cloud-builders/npm'
    args: ['run', 'build']

  # Build web and node images.
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/production-deployment/multi_web:$TAG_NAME", "-f", "build/web/Dockerfile", "."]
  - name: 'gcr.io/cloud-builders/docker'
    args: ["push", "gcr.io/production-deployment/multi_web:$TAG_NAME"]
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/production-deployment/multi_node:$TAG_NAME", "-f", "build/node/Dockerfile", "."]
  - name: 'gcr.io/cloud-builders/docker'
    args: ["push", "gcr.io/production-deployment/multi_node:$TAG_NAME"]

  # Update k8s.
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ["set", "image", "deployment", "web-deployment", "web=gcr.io/production-deployment/multi_web:$TAG_NAME"]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-east1-b'
    - 'CLOUDSDK_CONTAINER_CLUSTER=cluster-1'
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ["set", "image", "deployment", "monitor-deployment", "monitor=gcr.io/production-deployment/multi_monitor:$TAG_NAME"]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-east1-b'
    - 'CLOUDSDK_CONTAINER_CLUSTER=cluster-1'
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ["set", "image", "deployment", "node-deployment", "node=gcr.io/production-deployment/multi_node:$TAG_NAME"]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-east1-b'
    - 'CLOUDSDK_CONTAINER_CLUSTER=cluster-1'


images:
  - "gcr.io/production-deployment/multi_monitor:$TAG_NAME"
  - "gcr.io/production-deployment/multi_node:$TAG_NAME"
  - "gcr.io/production-deployment/multi_web:$TAG_NAME"
