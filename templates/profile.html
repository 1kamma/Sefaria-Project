{% extends "base.html" %}

{% load sefaria_tags %}
{% load humanize %}

{% block title %}{{ user.first_name }} {{ user.last_name }} on Sefaria.org{% endblock %}

{% block content %}

<div id="profile" class="container">
	<div id="profileLeft" class="span4">
		
		<div id="profileLeftBox">
		<img id="profileImage" src="{{ profile.imageURL|default:'http://placehold.it/250x250' }}" />
		<span id="profileName">{{ user.first_name }} {{ user.last_name }}</span>

		<div id="tagline">
			<span id="position">{{ profile.position }}</span>
			<span id="at">{% if profile.organization %}at{% endif %}</span>
			<span id="organization">{{ profile.organization}}</span>
		</div>

		<div id="profileWebsite"><a href="http://{{ profile.website }}">{{ profile.website }}</a></div>
		<div id="profileLocation">{{ profile.location }}</div>


		<div id="bio" class="view">{{ profile.bio }}</div>

		<div id="buttons">
			{% if profile.id != request.user.id %}
				<div id="messageMe" class="btn bt-mini btn-primary">Message</div>
				<div id="followMe" class="{% if following %}following{% endif %} btn bt-mini btn-success"><span></span></div>
			{% endif %}
			{% if profile.id == request.user.id %}
				<a id="editProfile" href="/settings/profile" class="btn btn-primary">Edit Profile</a>
			{% endif %}
		</div>

		<div id="profileStats">
			<span id="pointsCount" class="score">{{ score|intcomma }} Points</span>
			<span id="followersCount" class="score">{{ profile.followers.count }}</span>
			<span id="followeesCount" class="score">{{ profile.followees.count }}</span>

			<div id="joinStats">
				<span>Joined {{ joined|naturaltime }}</span>
				{% if contributed %}
				<span>Last contributed {{ contributed|naturaltime }}</span>
				{% endif %}
			</div>
			

			{% if profile.email or profile.facebook or profile.twitter %}
			<div id="profileContact">
				<div id="profileEmail"><a href="mailto:{{ profile.email }}">{{ profile.email }}</a></div>
				<div id="profileFacebook"><a href="http://{{ profile.facebook }}">Facebook</a></div>
				<div id="profileTwittr"><a href="http://{{ profile.twitter }}">Twitter</a></div>
			</div>
			{% endif %}


			{% if user_texts|length %}
			<div id="userTextsBox">
				<h4>Contributed to:</h4>
				{% for text in user_texts %}
				 	<span class="userText">{{ text|ref_link }}</span>
				{% endfor %}
			</div>
			<br>
			{% endif %}


		</div>
		</div>
	</div>

	<div id="profileRight" class="span7">

		<div id="profileSheets">
			<h3>Public Source Sheets - {{ sheets.count }}</h3>
			{% for sheet in sheets %}
			<div class="sheet">{{ sheet.id|sheet_link }}</div>
			{% empty %}
			<i>{{ profile.first_name }} hasn't created any public source sheets yet.</i>
			{% endfor %}
			<div class="line"></div>
		</div>

		<div id="profileNotes">
			<h3>Public Notes - {{ notes|length|default:"0" }}</h3>
			{% include "elements/activity_feed.html" with activity=notes single=1 %}
			<div class="line"></div>
		</div>

		<div id="activity">
			<h3>Public Activity - {{ score|intcomma }}</h3>
			{% include "elements/activity_filter.html" %}		
			{% include "elements/activity_feed.html" %}
		</div>
	</div>
</div>

{% include "elements/login_prompt.html" with msg="To send a message, please log in." %}

{% endblock %}

{% block js %}
	<script src="/static/js/jquery.autosize.js"></script>
	<script>
		$(function(){
			/*
			$("#editProfile, #cancelEditProfile").click(function(){
				$("#customFields").toggleClass("view").toggleClass("edit");
			});
			$("#saveProfile").click(function(){
				var profile = {
					position: $("#positionEdit").val(),
					organization: $("#organizationEdit").val(),
					bio: $("#bioEdit").val()
				};

				$.post("/api/profile", {json: JSON.stringify(profile)}, function(data) {
					if ("error" in data) {
						sjs.alert.message(data.error);
					}
				});

				$("#bio").text(profile.bio);
				$("#position").text(profile.position);
			$("#organization").text(profile.organization);
				$("#at").html(profile.organization ? "at" : "");
				$("#customFields").toggleClass("view").toggleClass("edit");
			});
			
			$("#bioEdit").autosize();

			*/

			$("#followMe").click(function(){
				{% if request.user.is_authenticated %}		
					var $fc = $("#followersCount");
					var count = parseInt($fc.text());
					if ($(this).hasClass("following")) {
						var action = "unfollow";
						$(this).removeClass("following");
						$fc.text(count-1);
					} else {
						var action = "follow";
						$(this).addClass("following");
						$fc.text(count+1);
					}  
					$.post("/api/" + action + "/{{ profile.id }}", {}, function(data) {
						// sjs.track.event("Follwoing", "New Follow", "");
					});
				{% else %}
					sjs.loginPrompt();
				{% endif %}
			});
		});
	</script>
{% endblock %}