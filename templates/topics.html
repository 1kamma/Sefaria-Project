{% extends "base.html" %}

{% load sefaria_tags %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

	<div id="topicsPage">
		{% if group != "topics" %}
			<center>
				<img id="partnerLogo" src="/static/partner/{{ group|url_safe }}/logo.png" alt="{{ group }}">
			</center>
		{% else %}
			<h1>{{ title }}</h1>
		{% endif %}
		<ul id="topics">
			{% if not in_group and not user.id %}
			<span id="loginMsg">
				If you are a member of the {{ group }} group, <a href="/login?next=/partners/{{ group|url_safe }}">login</a> to view private group sheets.
			</span>
			<div class="clear"></div>
			{% endif %}
			{% for topic in topics %}
			<li class="topic">
				{% if topic.url %}
					<a class="title" href="/topics/{{ topic.url }}">{{ topic.title }}</a>
				{% else %}
					<a class="title" href="/sheets/{{ topic.id }}">{{ topic.title }}</a>
				{% endif %}
					<div class="right">
						<span class="author">{{ topic.owner|user_link }}</span>
						<span class="topicSize">{{ topic.sources|length }} Sources</span>
						<span class="modified">{{ topic.dateModified|nice_timestamp }}</span>
					</div>
			</li>
			{% endfor %}
			<div class="clear"></div>
		</ul>
		<div class="clear"></div>
		
		{% if in_group %}
		<input id="newTopic"/>
		<div id="suggestTopic" class="btn">Suggest a Topic</div>
		{% endif %}

	</div>

{% endblock %}

{% block js %}
	<script>{% include "js/django-csrf.js" %}</script>
	<script>
		$("img").error(function () { 
		    $(this).hide().after("<h1>"+$(this).attr("alt")+"</h1>");
		});
		$(function() {
			$("#suggestTopic").click(function(){
				if (!$("#newTopic").val()) { return; }
				var topic = {
					status: {{ status }},
					group: "{{ group }}",
					title: $("#newTopic").val(),
					sources: []
				};

				{% if status == 5 %}
				topic.url = $("#newTopic").val().replace(/ /g, "-").replace(/[.,;:'"]/g, "");
				{% endif %}

				$.post("/api/sheets/", { json: JSON.stringify(topic) }, function(data){
					if (data.status == 6) {
						$(".topic").last().find('a').attr("href", "/sheets/" + data.id);
					}
				});

				var url = {{ status }} == 5 ? "/topics/" + topic.url : ""
				$("#topics .clear").before("<li class='topic'><a href='" + url + "'>" + topic.title + " <span class='topicSize'>0</span></a></li>");
				$("#newTopic").val("").focus();
			});
			$("#newTopic").on("keypress", function(e) {
				if (e.keyCode === 13) {
					$("#suggestTopic").trigger("click");
				}
			});
		});
	</script>
{% endblock %}