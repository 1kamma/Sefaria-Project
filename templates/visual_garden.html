{% extends "base.html" %}

{% load sefaria_tags %}


{% block title %}{{ title }}{% endblock %}
{% block head %}
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
<script src="/static/js/dc.js"></script>
<link rel="stylesheet" href="/static/css/dc.css">
{%  endblock %}

{% block css %}
    #languageToggle {
        display: inline;
    }
    #languageToggle #bilingual {
        display: none;
    }
{% endblock %}

{% block content %}





<div id="visualGardenPage" class="container doc biReady">

    <span class="row">
        <span class="span12">
            <h1>
                <span class='en'>{{ title }}</span>
                <span class='he'>{{ heTitle }}</span>
            </h1>
        </span>
    </span>

    <span class="row">
        <span class="span12">
            <div id="timeline-chart">
                <div style="height: 30px;">
                    <span class='reset' style='display: none;'>
                      Current filter: <span class='filter'></span>
                    </span>
                    <a class='reset'
                      href='javascript:timeline.filterAll();dc.redrawAll();'
                      style='display: none;'>reset</a>
                </div>
            </div>
        </span>
    </span>

    <span class="row">
        <span class="span2">
            <div id="tags-list">
                <div style="height: 30px;">
                    <span class='reset' style='display: none;'>
                      Current filter: <span class='filter'></span>
                    </span>
                    <a class='reset'
                      href='javascript:tagslist.filterAll();dc.redrawAll();'
                      style='display: none;'>reset</a>
                </div>
            </div>
        </span>
        <span class="span9">
            <div id="map-chart">
                <div style="height: 30px;">
                    <span class='reset' style='display: none;'>
                      Current filter: <span class='filter'></span>
                    </span>
                    <a class='reset'
                      href='javascript:mapchart.filterAll();dc.redrawAll();'
                      style='display: none;'>reset</a>
                </div>
            </div>
        </span>
    </span>
    <span class="row">
        <span class="span9">
             <span class="row" style="height: 30px;">
                <span class="span9">
                    <div id="data-count">
                    </div>
                </span>
            </span>
            <span class="row">
                <span class="span9">
                    <table id="results-table">
                    </table>
                </span>
            </span>
        </span>
    </span>



</div>

{% endblock %}

{% block js %}
    <script>
    {% autoescape off %}
        var timeline = dc.barChart("#timeline-chart");
        var tagslist = dc.rowChart("#tags-list");
        var results = dc.dataTable("#results-table");
        var datacount = dc.dataCount("#data-count");
        var mapchart = dc.geoChoroplethChart("#map-chart");

        var stops = {{ stops }};
        var places = {{ places }};

        stops.forEach(function (d) {
            d.start = +d.start; // coerce to number
            d.end = +d.end;
        });
        var stopx = crossfilter(stops);
        var all = stopx.groupAll();
        var yearDim = stopx.dimension(function(d) { return d.start; }); //!!Using start as the year.
        var yearGroup = yearDim.group();
        //var refDim = stopx.dimension(function(d) {return d.ref; });
        var weightDim = stopx.dimension(function(d) {return d.weight; });
        var placeDim = stopx.dimension(function(d) { return d.placeKey; });
        var placeGroup = placeDim.group();

        datacount
            .dimension(stopx)
            .group(all)
            .html({
                some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records' +
                    ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'\'>Reset All</a>',
                all: 'All records selected. Please click on the graph to apply filters.'
            });


        // <br>API: [Bar Chart](https://github.com/dc-js/dc.js/blob/master/web/docs/api-latest.md#bar-chart)
        var tl_extent = d3.extent(stops, function (d) { return d.start; });
        tl_extent[0] -= 50;
        tl_extent[1] += 50;

        timeline
            .width(820)
            .height(180)
            .margins({top: 10, right: 50, bottom: 30, left: 40})
            .dimension(yearDim)
            .group(yearGroup)
            .elasticY(true)
            .xUnits(function(start, end, xDomain) { return Math.abs(end - start) / 40; }) // years in the domain / 40
            .round(dc.round.floor)
            .y(d3.scale.pow().domain([0, timeline.yAxisMax()]).range([140,0]).exponent(.5))
            .x(d3.scale.linear().domain(tl_extent));
        timeline.yAxis().ticks(5, d3.format("d"));
        timeline.xAxis().tickFormat(d3.format("d"));


        // tags chart
        function reduceAdd(p, v) {
            v.tags.default.forEach (function(val, idx) {
                p[val] = (p[val] || 0) + 1; //increment counts
            });
            return p;
        }

        function reduceRemove(p, v) {
            v.tags.default.forEach (function(val, idx) {
                p[val] = (p[val] || 0) - 1; //decrement counts
            });
            return p;
        }

        function reduceInitial() {
            return [];
        }


        var tags = stopx.dimension(function (d) { return d.tags.default || [] });
        var tags2 = stopx.dimension(function (d) { return d.tags.default || [] });
        var groupall = tags.groupAll();
        var tagsGroup = groupall.reduce(reduceAdd, reduceRemove, reduceInitial).value();
        tagsGroup.all = function() {
            var newObject = [];
            for (var key in this) {
                if (this.hasOwnProperty(key) && this[key] && key != "all" && key != "top") {
                    newObject.push({
                        key: key,
                        value: this[key]
                    });
                }
            }
            return newObject;
        };
        tagsGroup.top = function(k) {
            all = this.all();
            var top = crossfilter.heapselect(all, 0, all.length, k);
            return crossfilter.heap.sort(top, 0, top.length);
        };

        tagslist
            .width(200)
            .height(800)
            .renderLabel(true)
            .labelOffsetY(10)
            .gap(2)
            .group(tagsGroup)
            .rowsCap(25)
            .othersGrouper(false)
            .dimension(tags2)
            .ordering(function(d){ return -d.value })
            .elasticX(true)
            .transitionDuration(1000)
            .colors(d3.scale.category10())
            .label(function (d) { return d.key })
            .on("filtered", function(c,f) {
                //tags2.filter(f)
            })
            .filterHandler (function (dimension, filters) {
                dimension.filter(null);
                dimension.filterFunction(function (d) {
                    for (var i=0; i < filters.length; i++) {
                        if (d.indexOf(filters[i]) <0) return false;
                    }
                    return true;
                });



                return filters;
            });
        tagslist.xAxis().tickFormat(d3.format("d"));

        mapchart.width(990)
            .height(500)
            .projection(d3.geo.mercator())
            .dimension(placeDim)
            .group(placeGroup)
            .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
            .colorDomain([0, 200])
            .colorCalculator(function (d) { return d ? mapchart.colors()(d) : '#ccc'; })
            .overlayGeoJson(places.features, "placeLayer", function (d) {
                return d.id;
            });
        //Does this really optimize?  d3.geo.bounds(places)


        results
            .dimension(weightDim)
            .order(d3.descending)
            .group(function (d) { return d.weight; })
            .showGroups(false)
            .columns([
                'ref',
                {
                    label: "Author",
                    format: function(d) {return d.authors;}
                },
                {
                    label: "Period",
                    format: function(d) { return d.timePeriodEn; }
                },
                {
                    label: "Place",
                    format: function(d) {return d.placeNameEn;}
                },
                'weight',
            ])
            .on('renderlet', function (table) {
              table.selectAll('.dc-table-group').classed('info', true);
            });

        dc.renderAll();

    {% endautoescape %}
    </script>
{% endblock %}
